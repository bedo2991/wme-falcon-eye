// ==UserScript==
// @name        WME Falcon Eye
// @namespace   bedo2991-waze
// @version     1.2.2
// @description validates doglegs for Falcon
// @updateURL    https://github.com/bedo2991/wme-falcon-eye/releases/latest/download/wme-falcon-eye.user.js
// @downloadURL  https://github.com/bedo2991/wme-falcon-eye/releases/latest/download/wme-falcon-eye.user.js
// @author      bedo2991
// @match       https://www.waze.com/editor*
// @match       https://beta.waze.com/editor*
// @match       https://www.waze.com/*/editor*
// @match       https://beta.waze.com/*/editor*
// @exclude     https://www.waze.com/user/editor*
// @exclude     https://beta.waze.com/user/editor*
// @exclude     https://www.waze.com/editor/sdk*
// @exclude     https://beta.waze.com/editor/sdk*
// @website     https://docs.google.com/document/d/16p3AQg5-7HM-fz92ykkAipADnO3Aw2j3oCLCNmOml5c/edit?usp=sharing
// @require     https://update.greasyfork.org/scripts/24851/1558013/WazeWrap.js
// @supportURL  https://www.waze.com/discuss/t/script-wme-falcon-eye/391102
// @grant       none
// ==/UserScript==

!function(){"use strict";var e,t=6371008.8,n={centimeters:637100880,centimetres:637100880,degrees:360/(2*Math.PI),feet:20902260.511392,inches:39.37*t,kilometers:6371.0088,kilometres:6371.0088,meters:t,metres:t,miles:3958.761333810546,millimeters:6371008800,millimetres:6371008800,nauticalmiles:t/1852,radians:1,yards:6967335.223679999};function o(e){return e%360*Math.PI/180}function r(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if("Feature"===e.type&&null!==e.geometry&&"Point"===e.geometry.type)return[...e.geometry.coordinates];if("Point"===e.type)return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function i(e,t,n={}){if(!0===n.final)return function(e,t){let n=i(t,e);return n=(n+180)%360,n}(e,t);const a=r(e),s=r(t),l=o(a[0]),d=o(s[0]),c=o(a[1]),g=o(s[1]),m=Math.sin(d-l)*Math.cos(g),f=Math.cos(c)*Math.sin(g)-Math.sin(c)*Math.cos(g)*Math.cos(d-l);return Math.atan2(m,f)%(2*Math.PI)*180/Math.PI}function a(e,t,i={}){var a=r(e),s=r(t),l=o(s[1]-a[1]),d=o(s[0]-a[0]),c=o(a[1]),g=o(s[1]),m=Math.pow(Math.sin(l/2),2)+Math.pow(Math.sin(d/2),2)*Math.cos(c)*Math.cos(g);return function(e,t="kilometers"){const o=n[t];if(!o)throw new Error(t+" units is invalid");return e*o}(2*Math.atan2(Math.sqrt(m),Math.sqrt(1-m)),i.units)}!function(e){e.Segments="Falcon Eye",e.Labels="Falcon Eye Labels"}(e||(e={})),window.SDK_INITIALIZED.then(function(){let t=200;if(!window.getWmeSdk)throw new Error("SDK not available");const n=window.getWmeSdk({scriptId:"wme-falcon-eye",scriptName:"WME Falcon Eye"});let o;!function(e){e.INFO="info",e.ERROR="error",e.SUCCESS="success",e.WARNING="warning",e.DEBUG="debug"}(o||(o={}));const r=(e,t)=>{try{WazeWrap.Alerts[e](GM_info.script.name,t)}catch(e){console.error(e),alert(t)}},s=GM_info.script.version,l=GM_info.script.name;let d;!function(e){e.enabled="E",e.disabled="D",e.zoom_disabled="ZD"}(d||(d={}));const c=!0,g=!0,m=!0,f=Object.seal({script_enabled:c,energy_saving:g,check_from_zoom:17,display_approved_doglegs:m}),p=180/Math.PI;function u({id:e,title:t,description:n}){const o=document.createElement("div"),r=document.createElement("label");r.innerText=t,o.className="prefLineCheckbox";const i=function({id:e,type:t,className:n,title:o,min:r,max:i,step:a}){const s=document.createElement("input");return s.id="dog_"+e,n&&(s.className=n),s.title=o,s.type=t,s}({id:e,type:"checkbox",title:"true or false"});r.appendChild(i),o.appendChild(r);const a=document.createElement("i");return a.innerText=n,o.appendChild(a),o}function h(e){const t=document.getElementById("dog_script_state");if(t)switch(e){case d.enabled:t.innerText="✅";break;case d.disabled:t.innerText="🛑";break;case d.zoom_disabled:t.innerText="🔍🔙";break;default:alert("DOG: Invalid state")}}function y(){f.script_enabled=c,f.energy_saving=g,f.check_from_zoom=17,f.display_approved_doglegs=m,b()}function b(){const e=document.getElementById("dog_enable"),t=document.getElementById("dog_displayOK"),n=document.getElementById("dog_energy"),o=document.getElementById("dog_zoom"),r=document.getElementById("dog_zoom");e&&(e.checked=f.script_enabled),n&&(n.checked=f.energy_saving),t&&(t.checked=f.display_approved_doglegs),o&&(o.value=String(f.check_from_zoom)),r&&(r.value=String(f.check_from_zoom))}function _(e){f.display_approved_doglegs=e.target.checked,f.display_approved_doglegs?r(o.INFO,"The script will show all approved doglegs."):r(o.WARNING,"The script will hide approved doglegs. There is no way to know if a dogleg was really checked or not."),w(),f.script_enabled&&N()}function w(){try{localStorage.setItem("falcon-eye",JSON.stringify({v:s,settings:{script_enabled:f.script_enabled,energy_saving:f.energy_saving,check_from_zoom:f.check_from_zoom,display_approved_doglegs:f.display_approved_doglegs}}))}catch(e){r(o.ERROR,"Could not store settings in your browser")}}function I(e){f.check_from_zoom=parseInt(e.target.value),w()}function v(e){f.script_enabled=e.target.checked,w(),E(),f.script_enabled&&N()}function E(){f.script_enabled?(C(),S=n.Events.on({eventHandler:N,eventName:"wme-map-data-loaded"}),T=n.Events.on({eventHandler:N,eventName:"wme-data-model-objects-changed"}),n.Events.trackDataModelEvents({dataModelName:"segments"}),h(d.enabled)):(C(),L(),h(d.disabled))}function M(e){f.energy_saving=e.target.checked,r(o.INFO,f.energy_saving?"The script will stop looking for problems after finding the first one":"The script will show all doglegs problems at once"),w()}function k(e){return new Promise(t=>setTimeout(t,e))}let S=()=>{},T=()=>{};function C(){S(),T(),n.Events.stopDataModelEventsTracking({dataModelName:"segments"}),S=()=>{},T=()=>{}}function L(){n.Map.removeAllFeaturesFromLayer({layerName:e.Segments}),n.Map.removeAllFeaturesFromLayer({layerName:e.Labels})}function N(){L(),n.Map.getZoomLevel()>=f.check_from_zoom?(h(d.enabled),async function(e=[]){if(x)for(z=!0;x;)await new Promise(e=>setTimeout(e,10));x=!0,z=!1;let n=t;try{for(let t=0;t<e.length;t+=n){if(z)return;const o=e.slice(t,t+n),r=performance.now();for(let e=0;e<o.length;e++){if(z)return;let t=W(o[e]);!0===t.isDoglegCandidate&&(P(t,f.energy_saving)?f.display_approved_doglegs&&G(t):R(t))}const i=performance.now()-r,a=o.length===n;i<110&&a&&n<1e3?n=Math.min(1e3,Math.floor(1.25*n)):i>150&&n>10&&(n=Math.max(10,Math.floor(.75*n))),t+n<e.length&&await new Promise(e=>setTimeout(e,0))}}finally{t=n,x=!1}}(n.DataModel.Segments.getAll())):h(d.zoom_disabled)}function D(e,t,n=!0){let o=t-e;return o>180&&(o-=360),o<-180&&(o+=360),n?o:o>0?o-180:o+180}function W(e){const t={isDoglegCandidate:!1};if(!e)return console.warn("Segment S1 not found"),t;let o=null,r=null;if(e.isTwoWay)return t;let i=e.roadType;if(![3,6,7].includes(i))return t;if(null!==e.junctionId)return t;let a=null;if(e.isAtoB&&e.toNodeId?a=n.DataModel.Nodes.getById({nodeId:e.toNodeId}):e.fromNodeId&&(a=n.DataModel.Nodes.getById({nodeId:e.fromNodeId})),!a)return t;const s=a.connectedSegmentIds;if(3!==s.length)return t;for(let i=0;i<s.length;i++){if(s[i]===e.id)continue;const l=n.DataModel.Segments.getById({segmentId:s[i]});if(l){if(!n.DataModel.Turns.isTurnAllowedBySegmentDirections({fromSegmentId:e.id,toSegmentId:s[i],nodeId:a.id}))return t;if(4===l.roadType){if(r)return t;if(l.isTwoWay)return t;r=l}else{if(l.roadType!==e.roadType)return t;if(o)return t;if(l.isTwoWay)return t;o=l}}}return o&&r?{isDoglegCandidate:!0,s1Id:e.id,s2Id:o.id,offrampId:r.id,nodeId:a.id}:(console.info("Dogleg almost detected..."),t)}let x=!1,z=!1;function O(t){n.Map.addFeatureToLayer({feature:t,layerName:e.Labels})}function B(e,t,n=0,o=0){return{geometry:{coordinates:[t[0],t[1]],type:"Point"},id:Date.now().toString(),properties:{label:e,xOffset:n,yOffset:o},type:"Feature"}}function F({geometry:e,properties:t}){return{geometry:{coordinates:e,type:"LineString"},id:Date.now().toString(),properties:t,type:"Feature"}}function A(t,o){const r=function(e){const t=n.DataModel.Segments.getById({segmentId:e});if(!t)throw"Segment S1 not found";const o=t.geometry.coordinates;let r,i;return t.isAtoB?(r=o[o.length-2],i=o[o.length-1]):(r=o[1],i=o[0]),[r,i]}(t.s1Id);t.angle1&&O(B(`_._: ${t.angle1.toFixed(2)}°`,r[1],30,-30)),t.angle2&&O(B(`⑂: ${t.angle2.toFixed(2)}°`,r[1],30,30));let i,a=null;t.s1_length?(a=F({geometry:r,properties:{isError:!0}}),O(B(`${t.s1_length.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}m`,r[0],30,30))):a=F({geometry:r,properties:{isWarning:!!o}});try{i=function(e){let t,o;const r=n.DataModel.Segments.getById({segmentId:e}),i=r?.geometry.coordinates;if(!i)throw"Geometry not found";if(i.length<3)throw"Ramp does not have enough subsegments.";return r.isAtoB?(t=i[1],o=i[2]):(t=i[i.length-2],o=i[i.length-3]),[t,o]}(t.offrampId)}catch(e){return}let s=null;t.delta&&O(B(`Δ: ${t.delta.toFixed(2)}°`,i[0],30,30)),t.offramp_length?(s=F({geometry:i,properties:{isError:!0}}),O(B(`${t.offramp_length.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})}m`,i[0],-30,-30))):s=F({geometry:i,properties:{isWarning:!!o}}),n.Map.addFeaturesToLayer({features:[a,s],layerName:e.Segments})}function G(e){A(e,!1)}function R(e){A(e,!0)}function P(e,t=!1){if(t)return U(e)&&H(e)&&j(e)&&q(e)&&J(e);let n=U(e);return n=H(e)&&n,n=j(e)&&n,n=q(e)&&n,n=J(e)&&n,n}function $(e,t){return a(e,t,{units:"meters"})}function K(e){let t,o;const r=n.DataModel.Segments.getById({segmentId:e}),i=r?.geometry.coordinates;if(!i)throw"Geometry not found";if(i.length<3)throw"Ramp does not have enough subsegments.";return r.isAtoB?(t=i[1],o=i[2]):(t=i[i.length-2],o=i[i.length-3]),[t,o]}function U(e){if(!e.s1Id)throw"Could not find the offramp id";let[t,o]=function(e){let t,o;const r=n.DataModel.Segments.getById({segmentId:e}),i=r?.geometry.coordinates;if(!i)throw"Geometry not found";return r?.isAtoB?(t=i[i.length-2],o=i[i.length-1]):(t=i[1],o=i[0]),[t,o]}(e.s1Id),r=$(t,o);return r>12||(e.s1_length=r,!1)}function H(e){let t,n;const o=e.offrampId;if(!o)throw"Could not find the offramp id";try{[t,n]=K(o)}catch(e){return console.warn(e),!1}let r=$(t,n);return r>12||(e.offramp_length=r,!1)}function Z(e,t){const o=n.DataModel.Segments.getById({segmentId:t});if(!o)throw"Segment not found";const r=o.geometry.coordinates;let a,s;if(o.fromNodeId===e)a=r[0],s=r[1];else{if(o.toNodeId!==e)throw"Node is not connected to the segment";a=r[r.length-1],s=r[r.length-2]}let l=i(a,s);return l<0&&(l=360+l),l}function j(e){let t=Math.abs(D(Z(e.nodeId,e.s1Id),Z(e.nodeId,e.s2Id)));return t>170&&t<190||(e.angle1=t,!1)}function q(e){let t=Math.abs(D(Z(e.nodeId,e.s2Id),Z(e.nodeId,e.offrampId)));return t>20&&t<55||(e.angle2=t,!1)}function J(e){let t,o;if(!e.offrampId||!e.s2Id)throw"Could not find the offramp or s2 id";try{[t,o]=K(e.offrampId)}catch(e){return console.warn(e),!1}let r=Math.atan2(o[1]-t[1],o[0]-t[0])*p,[i,a]=function(e){let t,o;const r=n.DataModel.Segments.getById({segmentId:e}),i=r?.geometry.coordinates;if(!i)throw"Geometry not found";return r?.isAtoB?(t=i[0],o=i[1]):(t=i[i.length-1],o=i[i.length-2]),[t,o]}(e.s2Id),s=Math.atan2(a[1]-i[1],a[0]-i[0])*p,l=Math.abs(D(s,r));return l<10||(e.delta=l,!1)}!async function(){!function(){const e=localStorage.getItem("falcon-eye");if(!e)return console.log("Falcon Eye running for the first time in this browser"),void y();const t=JSON.parse(e);if(!t)return console.warn("Falcon Eye: setting found, but could not parse them."),console.log("Falcon Eye running for the first time in this browser"),void y();console.log("Falcon Eye: loading settings from the local storage."),f.script_enabled=t.settings.script_enabled,f.energy_saving=t.settings.energy_saving,f.display_approved_doglegs=t.settings.display_approved_doglegs,f.check_from_zoom=t.settings.check_from_zoom}(),n.Map.addLayer({layerName:e.Segments,styleRules:[{style:{pointerEvents:"none",strokeColor:"#00ff00",strokeWidth:25,strokeOpacity:.5,strokeDashstyle:"solid",strokeLinecap:"butt"}},{predicate:e=>!!e.isError,style:{pointerEvents:"none",strokeColor:"#ff0000",strokeWidth:25,strokeOpacity:.5,strokeDashstyle:"solid",strokeLinecap:"butt"}},{predicate:e=>!!e.isWarning,style:{pointerEvents:"none",strokeColor:"#9932CC",strokeWidth:25,strokeOpacity:.5,strokeDashstyle:"solid",strokeLinecap:"butt"}}]}),n.Map.addLayer({layerName:e.Labels,styleContext:{getLabel:({feature:e})=>e?.properties.label??"",getXOffset:({feature:e})=>e?.properties.xOffset??0,getYOffset:({feature:e})=>e?.properties.yOffset??0},styleRules:[{style:{fontFamily:"Rubik, Open Sans, Alef, helvetica, sans-serif",label:"${getLabel}",labelYOffset:"${getXOffset}",labelXOffset:"${getYOffset}",fontColor:"#f00",fontSize:"30",fontWeight:"800",labelOutlineColor:"#4B0082",labelOutlineWidth:2,pointerEvents:"none",graphic:!1,labelAlign:"cm",visibility:!0}}]}),E(),async function(){const e=document.createElement("div"),t=document.createElement("h4");t.innerText=l,e.appendChild(t);const o=document.createElement("span");o.innerText=`Version ${s}`,e.appendChild(o);const r=document.createElement("div");r.id="dog_script_state",r.style.float="right",e.appendChild(r);let i=u({id:"enable",title:"Script enabled",description:"When checked, segments get analysed for doglegs"});e.appendChild(i);let a=u({id:"energy",title:"Energy saving",description:"When checked, the segment verification stops as soon as a problem has been found."});e.appendChild(a);let c=u({id:"displayOK",title:"Display approved doglegs in green",description:"When checked, segments that are OK will be displayed."});e.appendChild(c);let g=function({id:e,title:t,description:n,options:o,isNew:r}){const i=document.createElement("div");i.className="prefLineSelect","string"==typeof r&&(i.classList.add("newOption"),i.dataset.version=r);const a=document.createElement("select");a.className="prefElement";const s=document.createElement("label");s.innerText=t,a.id=`dog_${e}`,o&&o.length>0&&o.forEach(e=>{const t=document.createElement("option");t.text=e,t.value=e,a.add(t)});const l=document.createElement("i");return l.innerText=n,i.appendChild(s),i.appendChild(l),i.appendChild(a),i}({id:"zoom",title:"Enabled from zoom (Default: 17)",description:"The script only scans the map from zoom ",options:["14","15","16","17","18","19","20","21","22"]});e.appendChild(g);const m=document.createElement("style");m.textContent=".dog_errorLine {\n            padding: 5pt;\n            color: #3d3d3d;\n            background-color: #eeeeee;\n            border-bottom: 1px solid black;\n            }\n            .dog_prefLineCheckbox{width:100%; margin-bottom:1vh;}\n            .dog_prefLineCheckbox label{display:block;width:100%}\n            .dog_prefLineCheckbox input{float:right;}\n            ",document.head.appendChild(m);const p=document.createElement("h5");p.innerText="Heuristic rules",e.appendChild(p);const y=document.createElement("div");y.innerText="[_._]: should be between 170° and 190°",y.className="dog_errorLine",e.appendChild(y);const w=document.createElement("div");w.innerText="[⑂]: should be between 20° and 55°",w.className="dog_errorLine",e.appendChild(w);const E=document.createElement("div");E.innerText="The 2nd subsegment of the offramp should be at least 12m long",E.className="dog_errorLine",e.appendChild(E);const k=document.createElement("div");k.innerText="The last subsegment of the incoming highway should be at least 12m long",k.className="dog_errorLine",e.appendChild(k);const S=document.createElement("div");S.innerText="Δ: The difference between the heading of the 1st subsegment of the outgoing highway and the 2nd subsegment of the offramp may differ of maximum  10°",S.className="dog_errorLine",e.appendChild(S);const{tabLabel:T,tabPane:C}=await n.Sidebar.registerScriptTab();T.innerText="🐦",T.title="Falcon Eye",C.innerHTML=e.innerHTML,b(),function(){const e=document.getElementById("dog_enable"),t=document.getElementById("dog_energy"),n=document.getElementById("dog_displayOK"),o=document.getElementById("dog_zoom");e&&e.addEventListener("click",v),t&&t.addEventListener("click",M),n&&n.addEventListener("click",_),o&&o.addEventListener("change",I)}(),f.script_enabled?n.Map.getZoomLevel()>=f.check_from_zoom?h(d.enabled):h(d.zoom_disabled):h(d.disabled)}(),async function(){let e=1;do{if(WazeWrap&&WazeWrap.Ready&&WazeWrap.Interface&&WazeWrap.Alerts)return!0;console.log("DOG: WazeWrap not ready, retrying in 800ms"),await k(400*e)}while(e++<=30);throw console.error("DOG: could not initialize WazeWrap"),new Error("DOG: could not initialize WazeWrap")}().then(e=>{!0===e&&WazeWrap.Interface.ShowScriptUpdate(l,s,"<b>What's new?</b>\n            <ul>\n            <li>1.2.2: Improved performance, the WME should not freeze when a lot of segments get loaded at once. Improved settings and storage</li>\n            <li>1.2.1: Fix for inaccurate angle computation after moving to the SDK. Better handling of the settings states</li>\n            <li>1.1.1: Use the new WME SDK.</li>\n            <li>1.0.0: Use the new WME API, store the settings when they get changed.</li>\n            <li>0.0.9.5: The checkbox to disable the script now really disables the script. It is possible to select from what zoom level the script should work. The script state gets displayed in the script's panel.</li>\n            </ul>","",GM_info.script.supportURL)}),N()}()})}();
